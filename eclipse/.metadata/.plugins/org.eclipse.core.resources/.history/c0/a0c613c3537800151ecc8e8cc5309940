package com.derf.ei.multiblock;

import java.util.ArrayList;

import net.minecraft.block.Block;
import net.minecraft.world.World;

import com.derf.ei.block.EIBlocks;

public abstract class EIMultiBlockTotem extends EIMultiBlock {
	
	class BlockRecipe {
		private Block inputBlock;
		private Block outputBlock;
		private float duration;
		
		BlockRecipe(Block inputBlock, Block outputBlock, float duration) {
			this.inputBlock = inputBlock;
			this.outputBlock = outputBlock;
			this.duration = duration;
		}
		
		public Block getInputBlock() {
			return inputBlock;
		}
		
		public Block getOuputBlock() {
			return outputBlock;
		}
		
		public float getDuration() {
			return duration;
		}
		
		public boolean isInputBlock(Block block) {
			return inputBlock.getUnlocalizedName().equals(block.getUnlocalizedName());
		}
	}
	
	class BlockSlot {
		private final static float INTERVAL = 20.0f / 1000.0f;
		
		private int x;
		private int y;
		private int z;
		private float duration;
		private boolean isProcessing = false;
		
		public BlockSlot(int x, int y, int z) {
			this.x = x;
			this.y = y;
			this.z = z;
			this.setDuration(-1);
		}
		
		public float getDuration() {
			return duration;
		}
		
		public void setDuration(float duration) {
			this.duration = duration;
		}
		
		public int getX() {
			return x;
		}
		
		public int getY() {
			return y;
		}
		
		public int getZ() {
			return z;
		}
		
		public void update(World world, ArrayList<BlockRecipe> recipes) {
			Block block = world.getBlock(this.getX(), this.getY(), this.getZ());
			
			for(int i = 0; i < recipes.size(); i++) {
				if(recipes.get(i).isInputBlock(block)) {
					if(!isProcessing) {
						isProcessing = true;
						this.setDuration(recipes.get(i).getDuration());
					}
					
					if(this.getDuration() <= 0.0f) {
						world.setBlock(this.getX(), this.getY(), this.getZ(), recipes.get(i).getOuputBlock());
						this.isProcessing = false;
					} else {
						this.setDuration(this.getDuration() - INTERVAL);
					}
				}
			}
		}
	}
	
	protected ArrayList<BlockRecipe> recipes = new ArrayList<BlockRecipe>();
	
	protected BlockSlot[] blockSlots = new BlockSlot[8];
	
	protected ArrayList<Block> createBlockList(World world, int x, int y, int z) {
		ArrayList<Block> list = new ArrayList<Block>();
		
		list.add(world.getBlock(x-1, y, z));
		list.add(world.getBlock(x+1, y, z));
		list.add(world.getBlock(x, y, z-1));
		list.add(world.getBlock(x, y, z+1));
		list.add(world.getBlock(x-1, y, z-1));
		list.add(world.getBlock(x+1, y, z-1));
		list.add(world.getBlock(x+1, y, z+1));
		list.add(world.getBlock(x-1, y, z+1));
		list.add(world.getBlock(x, y+1, z));
		list.add(world.getBlock(x, y+2, z));
		
		return list;
	}
	
	protected boolean isMultiBlockComplete(World world, int x, int y, int z, Block block) {
		ArrayList<Block> blockList = this.createBlockList(world, x, y, z);
		boolean b = true;
		
		for(int i = 0; i < blockList.size() - 1; i++) {
			if(!EIBlocks.isVoidStone(blockList.get(i))) {
				b = false;
				break;
			}
		}
		
		if(!blockList.get(blockList.size() - 1).getUnlocalizedName().equals(block.getUnlocalizedName())) {
			b = false;
		}
		
		return b;
	}
	
	protected void checkSlotExist(World world, int x, int y, int z) {
		
		if(blockSlots[0] == null) {
			blockSlots[0] = new BlockSlot(x-1, y+1, z);
		}
		
		if(blockSlots[1] == null) {
			blockSlots[1] = new BlockSlot(x+1, y+1, z);
		}
		
		if(blockSlots[2] == null) {
			blockSlots[2] = new BlockSlot(x, y+1, z-1);
		}
		
		if(blockSlots[3] == null) {
			blockSlots[3] = new BlockSlot(x, y+1, z+1);
		}
		
		if(blockSlots[4] == null) {
			blockSlots[4] = new BlockSlot(x-1, y+1, z-1);
		}
		
		if(blockSlots[5] == null) {
			blockSlots[5] = new BlockSlot(x+1, y+1, z-1);
		}
		
		if(blockSlots[6] == null) {
			blockSlots[6] = new BlockSlot(x+1, y+1, z+1);
		}
		
		if(blockSlots[7] == null) {
			blockSlots[7] = new BlockSlot(x-1, y+1, z+1);
		}
	}
	
	protected void updateSlots(World world, ArrayList<BlockRecipe> recipes) {
		for(int i = 0; i < blockSlots.length; i++) {
			blockSlots[i].update(world, this.recipes);
		}
		
	}
	
	protected void addBlockRecipe(Block inputBlock, Block outputBlock, float duration) {
		this.recipes.add(new BlockRecipe(inputBlock, outputBlock, duration));
	}
}
